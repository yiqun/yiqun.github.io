<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
		<meta name="google-site-verification" content="ZHIKwo-o2HQJwtZ9Bt_S8Yt7_rq7ECBEM7HMEToXBck" />
		<title>svn预提交钩子(pre-commit)</title>
		<link type="text/css" rel="stylesheet" href="style.css" /> 
		<link type="text/css" rel="stylesheet" href="static/css/style.css" /> 
		<link type="text/css" rel="stylesheet" href="static/css/shCore.css" /> 
		<link type="text/css" rel="stylesheet" href="static/css/shThemeDefault.css" /> 
		<script type="text/javascript" src="static/js/shCore.js"></script> 
		<script type="text/javascript" src="static/js/shBrushPhp.js"></script>
		<script type="text/javascript" src="static/js/shBrushXml.js"></script>
		<script type="text/javascript" src="static/js/shBrushPlain.js"></script>
		<script type="text/javascript" src="static/js/shBrushJScript.js"></script>
		<script type="text/javascript" src="static/js/shBrushCss.js"></script>
		<script type="text/javascript" src="static/js/shBrushBash.js"></script>
		<script type="text/javascript" src="static/js/shBrushSql.js"></script>
		<script type="text/javascript">
			SyntaxHighlighter.all();
			function onload(){
				var e = document.getElementById('title');
				if ('/' != location.href.substr(-1) && -1 == location.href.indexOf('?q=') && -1 == location.href.indexOf('index.html')) {
					var e = document.getElementById('title');
					var c = document.createElement('a');
					c.href = '#';
					c.onclick = function(e){
						e.preventDefault();
						history.back(-1);
					};
					c.style.float = 'right';
					c.style.fontSize = '14px';
					c.style.fontWeight = 'normal';
					c.innerHTML = '&lt;返回';
					e.insertBefore(c, e.firstChild);
				} else {
					e.innerHTML = document.title = '逸群技术拾遗录';
					var s,dv,g,b;
					// google customer search
					s = document.createElement('style');
					s.type = 'text/css';
					s.appendChild(document.createTextNode('.gsc-control-wrapper-cse form.gsc-search-box{padding:0;margin:0}'
								+'div.gsc-control-cse.gsc-control-cse-zh_CN{padding:0}'
								+'#wrap>#content>#article>ul>li{display:inline-block;width:33%;}'));
					dv = document.createElement('div');
					dv.style.width = "600px";
					dv.style.float = 'right';
					dv.style.marginTop = '-30px';
					dv.style.marginBottom = 0;
					//g = document.createElement('gcse:searchbox-only');
					g = document.createElement('gcse:search');
					dv.appendChild(g);
					e.insertBefore(dv, e.firstChild);
					document.getElementsByTagName('head')[0].appendChild(s);
					(function() {
					 var cx = '013783129810095556381:WMX1457836548';
					 var gcse = document.createElement('script');
					 gcse.type = 'text/javascript';
					 gcse.async = true;
					 gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
					 '//www.google.com/cse/cse.js?cx=' + cx;
					 var s = document.getElementsByTagName('script')[0];
					 s.parentNode.insertBefore(gcse, s);
					 })();
				}
			};
		</script> 
	</head>
	<body>
		<div id="wrap">
			<h4 id="title">svn预提交钩子(pre-commit)</h4>
			<hr>
			<script type="text/javascript">onload();</script>
			<div id="content">
				<div id="article">
					
<p>
实现：UTF-8文件编码检测, PHP语法检测，JS语法检测
</p>
<ol>
<li>
安装PHP，安装过程略

<li>
安装JS
<pre class="brush:bash">
			#Ubuntu
			sudo apt-get install spidermonkey-bin
			#CentOS
			curl -O http://ftp.mozilla.org/pub/mozilla.org/js/js-1.7.0.tar.gz
			tar zxvf js-1.7.0.tar.gz
			cd js/src
			make -f Makefile.ref
			mv Linux_All_DBG.OBJ/js /usr/local/bin/
</pre>

<li>
配置JSLINT
<pre class="brush:bash">
			#Ubuntu下js路径由/usr/local/bin/js改为/usr/bin/js
			curl -o /usr/local/bin/jslint https://github.com/douglascrockford/JSLint/blob/master/jslint.js
			chmod +x /usr/local/bin/jslint
			echo -e '#!/usr/local/bin/js\nif(typeof Object.create==="undefined"){Object.create=function(o){function F(){}F.prototype=o;return new F()}}if(!Object.keys){Object.keys=(function(){var hasOwnProperty=Object.prototype.hasOwnProperty,hasDontEnumBug=!({toString:null}).propertyIsEnumerable("toString"),dontEnums=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],dontEnumsLength=dontEnums.length;return function(obj){if(typeof obj!=="object"&amp;&amp;typeof obj!=="function"||obj===null){throw new TypeError("Object.keys called on non-object")}var result=[];for(var prop in obj){if(hasOwnProperty.call(obj,prop)){result.push(prop)}}if(hasDontEnumBug){for(var i=0;i&lt;dontEnumsLength;i++){if(hasOwnProperty.call(obj,dontEnums[i])){result.push(dontEnums[i])}}}return result}})()};\n' | cat - /usr/local/bin/jslint &gt; ~tmp &amp;&amp; mv -f ~tmp /usr/local/bin/jslint
			echo -e '\nvar src=(function(args){if(args.length&gt;0){var str="";for(var i=0;i&lt;args.length;i++){str+=args[i]}return str}return""})(arguments);JSLINT(src,{browser:true,indent:2});var ers=JSLINT.errors,ersl=ers.length;if(ersl&gt;0){var e=ers[0];print((e.reason.substr(-1)=="."?e.reason.substr(0,e.reason.length-1):e.reason)+" - on line "+e.line)};' &gt;&gt; /usr/local/bin/jslint
</pre>

<li>
配置pre-commit
<pre class="brush:php">
#!/usr/bin/php
&lt;?php
set_time_limit(0);
error_reporting(7);

// Set these manually since Subversion doesn't set ENV
$PHP = '/usr/bin/php';
$JSLINT = '/usr/local/bin/jslint';
$SVNLOOK = '/usr/bin/svnlook';
$AWK = '/usr/bin/awk';
$GREP = '/bin/egrep';
$SED = '/bin/sed';

$REPOS = $argv[1];
$TXN = $argv[2];

$errors = Array();

// Check comment
$comment = shell_exec("$SVNLOOK log -t '$TXN' '$REPOS'");
if (strlen($comment) &lt; 6){
        $errors[] = 'Please provide a meaningful comment when committing changes';
} else {
        // Find the changes
        $CHANGED=`$SVNLOOK changed -t "$TXN" "$REPOS" | $GREP "^[U|A]" | $AWK '{print $2}'`;
        // As an array
        $CHANGED = explode("\n",trim(rtrim($CHANGED)));

        /**
         * Detects the end-of-line character of a string.
         * @param string $str The string to check.
         * @return boolean
         */
        function detectLF($str){
                $es = array_count_values(str_split(preg_replace("/[^\r\n]/", "", $str)));
                $ea = array_keys($es, max($es));
                return in_array(bin2hex(implode("", $ea)),array("000a", "0a"));
        }

        // Perform specific actions based on the file extension 
        foreach($CHANGED as $FILE){
                $ext = pathinfo($FILE,PATHINFO_EXTENSION);
                $outputs = array();

                // Detect encoding, eol, tab
                if (in_array($ext, array('txt', 'html', 'xml', 'js', 'css', 'php', 'ini', 'csv', 'xls', 'xlst', 'property', 'properties'))){
                        $content = `$SVNLOOK cat -t '$TXN' '$REPOS' '$FILE'`;
                        // Detect encoding
                        if (!mb_detect_encoding($content, 'UTF-8', TRUE)){
                                $errors[] = "Only UTF-8 files can be committed ('$FILE')";
                                continue;
                        }
                        if (!detectLF($content)){
                                $errors[] = "File EOL must use LF ('$FILE')";
                                continue;
                        }
                        // Detect tab
                        $contents = explode("\n", $content);
                        $contents_length = count($contents);
                        for($ii=1;$ii&lt;=$contents_length;$ii++){
                            if (preg_match('/\t/is', $contents[$ii-1])){
                                $errors[] = "$FILE contains 'Tab' character - on line $ii";
                                continue 2;
                            }   
                        } 
                        // Detect syntax
                        $outputs = array();
                        switch($ext){
                                case 'php':
                                        $msg = exec("$SVNLOOK cat -t '$TXN' '$REPOS' '$FILE' | $PHP -l 2&gt;&amp;1", $outputs);
                                        array_pop($outputs);
                                        foreach ($outputs as $op) {
                                                $errors[] = $FILE. ':'.$op;
                                        }                        break;
                                case 'js':
                                        $msg = exec("$JSLINT \"`$SVNLOOK cat -t '$TXN' '$REPOS' '$FILE'`\" 2&gt;&amp;1", $outputs);
                                        foreach ($outputs as $op) {
                                                $errors[] = $FILE.':'.$op;
                                        }
                                        break;
                        }
                }
        }
}

// Print all the errors in a nice list
if(count($errors) &gt; 0){
        error_log("**********************************************************************\n Please correct the following errors before commiting these changes \n**********************************************************************");
        for($i = 1;$i &lt;= count($errors);$i++){
                error_log("$i. " . $errors[($i - 1)]);
        }

        exit(-1);
}

exit(0);
</pre>

</ol>

				</div>
			</div>
			<hr>
			<div id="disqus_thread"></div>
			<script type="text/javascript">
			/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
			var disqus_shortname = 'yiqungithubio'; // required: replace example with your forum shortname

			/* * * DON'T EDIT BELOW THIS LINE * * */
			(function() {
				 var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
				 dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
				 (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			 })();
			</script>
			<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
			<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
		</div>
	</body>
</html>
